import router from '@ohos.router';
import prompt from '@ohos.promptAction';

interface FeedItem {
  title: string;
  author: string;
  topic: string;
  time: string;
  tag?: string;
  summary?: string;
  images?: ResourceStr[]; // å›¾ç‰‡èµ„æºæ•°ç»„
  authorAvatar?: ResourceStr; // ä½œè€…å¤´åƒ
}

interface MessageItem {
  from: string;
  title: string;
  time: string;
  unread: boolean;
  avatar?: ResourceStr; // ç”¨æˆ·å¤´åƒ
}

interface KnowledgeBase {
  id: string;
  name: string;
  logo: ResourceStr;
  description: string;
  subscribers: number;
  contents: number;
  project?: string;
}

@Entry
@Component
export struct CNKIPage {
  @State currentTab: number = 0; // 0=é¦–é¡µ 1=å‘ç° 2=ç§ä¿¡
  @State query: string = '';
  @State filtered: FeedItem[] = [];
  @StorageLink('currentUser') currentUser: string = '';
  @State knowledgeBaseFlipStates: Map<string, boolean> = new Map(); // çŸ¥è¯†åº“ç¿»è½¬çŠ¶æ€

  // æ¨¡æ‹Ÿ"çŸ¥ä¹ä¹"å†…å®¹æ•°æ®
  private feedList: FeedItem[] = [
    { 
      title: 'è„¸ä¸èº«æä¸ç¬¦æ˜¯ç§æ€æ ·çš„ä½“éªŒï¼Ÿ', 
      author: 'ç­”ä¸» Â· ä¸å€’æ–—çš„èƒ¡å…«ä¸€', 
      topic: 'çƒ­æ¦œ Â· ç”Ÿæ´»', 
      time: '2024', 
      tag: 'ç”Ÿæ´»', 
      summary: 'åˆåˆ°äº†è¿™åªå…”å…”å‡ºç°çš„æ—¶å€™...',
      images: [
        $r('app.media.content_1'),
        $r('app.media.content_2')
      ],
      authorAvatar: $r('app.media.avatar_101')
    },
    { 
      title: 'ä¸ºä»€ä¹ˆè¯´ç”·äººè‡³æ­»éƒ½æ˜¯å°‘å¹´ï¼Ÿ', 
      author: 'ç­”ä¸» Â· å‘å‰', 
      topic: 'çƒ­æ¦œ Â· æƒ…æ„Ÿ', 
      time: '2024', 
      tag: 'æƒ…æ„Ÿ', 
      summary: 'ä¸ˆæ¯å¨˜å®¶å°åŒºæš–æ°”ç®¡çˆ†äº†,ä¸€å¤§æ—©åœ¨ä¿®...',
      images: [
        $r('app.media.content_3'),
        $r('app.media.content_4'),
        $r('app.media.content_5')
      ],
      authorAvatar: $r('app.media.avatar_102')
    },
    { 
      title: 'å¤§æ¨¡å‹ä¼šè®©å“ªäº›è¡Œä¸šç‡å…ˆå—ç›Šï¼Ÿ', 
      author: 'ç­”ä¸» Â· æç„¶', 
      topic: 'çƒ­æ¦œ Â· ç§‘æŠ€', 
      time: '2024', 
      tag: 'AI', 
      summary: 'æ•ˆç‡ã€åˆ›é€ åŠ›ã€å·¥å…·é“¾æ”¹é€ ä¸‰ä¸ªè§’åº¦çš„è¡Œä¸šè§‚å¯Ÿ',
      images: [
        $r('app.media.content_6')
      ],
      authorAvatar: $r('app.media.avatar_103')
    },
    { 
      title: 'ä¸ªäººå¦‚ä½•åšå¥½æ•°å­—å®‰å…¨é˜²æŠ¤ï¼Ÿ', 
      author: 'ç­”ä¸» Â· ç‹ç’', 
      topic: 'çƒ­æ¦œ Â· å®‰å…¨', 
      time: '2023', 
      tag: 'å®‰å…¨', 
      summary: 'å£ä»¤ç®¡ç†ã€åŒå› å­ã€è®¾å¤‡åŠ å¯†ä¸ç¤¾å·¥é˜²å¾¡æ¸…å•',
      images: [
        $r('app.media.content_7'),
        $r('app.media.content_8')
      ],
      authorAvatar: $r('app.media.avatar_104')
    },
    { 
      title: 'æ–°èƒ½æºè½¦ç”µæ± æœªæ¥äº”å¹´çš„çªç ´ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ', 
      author: 'ç­”ä¸» Â· é™ˆæ›¦', 
      topic: 'çƒ­æ¦œ Â· èƒ½æº', 
      time: '2025', 
      tag: 'èƒ½æº', 
      summary: 'å›ºæ€ç”µæ± ã€å¿«å……å®‰å…¨ã€å›æ”¶ä¸æ¢¯æ¬¡åˆ©ç”¨',
      images: [
        $r('app.media.content_9'),
        $r('app.media.content_10'),
        $r('app.media.content_11')
      ],
      authorAvatar: $r('app.media.avatar_105')
    },
    { 
      title: 'å¦‚ä½•ç”¨çŸ¥è¯†å›¾è°±åšå†…å®¹æ¨èï¼Ÿ', 
      author: 'ç­”ä¸» Â· èµµäº‘', 
      topic: 'ä¸“é¢˜ Â· æ¨è', 
      time: '2022', 
      tag: 'æ¨è', 
      summary: 'å®ä½“å…³ç³»è¡¥å…¨ã€æ ‡ç­¾æ‰©å±•ä¸å¯è§£é‡Šæ¨èç¤ºä¾‹',
      images: [
        $r('app.media.content_12')
      ],
      authorAvatar: $r('app.media.avatar_106')
    },
    { 
      title: 'è·¨å­¦ç§‘æé—®æ—¶ï¼Œè®©æ¨¡å‹ç†è§£ä½ çš„è¯­å¢ƒçš„æŠ€å·§ï¼Ÿ', 
      author: 'ç­”ä¸» Â· é’±ä¸ƒ', 
      topic: 'ä¸“é¢˜ Â· NLP', 
      time: '2021', 
      tag: 'NLP', 
      summary: 'æŸ¥è¯¢é‡å†™ã€ä¸Šä¸‹æ–‡çº¦æŸä¸å°‘æ ·æœ¬æç¤º',
      images: [
        $r('app.media.content_13'),
        $r('app.media.content_14'),
        $r('app.media.content_15')
      ],
      authorAvatar: $r('app.media.avatar_107')
    },
    { 
      title: 'å¦‚ä½•å¿«é€ŸæŒæ¡ä¸€é—¨æ–°çš„ç¼–ç¨‹è¯­è¨€ï¼Ÿ', 
      author: 'ç­”ä¸» Â· å¼ ä¼Ÿ', 
      topic: 'çƒ­æ¦œ Â· ç¼–ç¨‹', 
      time: '2024', 
      tag: 'ç¼–ç¨‹', 
      summary: 'ä»è¯­æ³•åŸºç¡€åˆ°é¡¹ç›®å®æˆ˜ï¼Œåˆ†äº«é«˜æ•ˆå­¦ä¹ è·¯å¾„å’Œå®è·µç»éªŒ',
      images: [
        $r('app.media.content_16')
      ],
      authorAvatar: $r('app.media.avatar_108')
    },
    { 
      title: 'æ·±åº¦å­¦ä¹ åœ¨åŒ»ç–—è¯Šæ–­ä¸­çš„åº”ç”¨å‰æ™¯å¦‚ä½•ï¼Ÿ', 
      author: 'ç­”ä¸» Â· åˆ˜æ•', 
      topic: 'çƒ­æ¦œ Â· åŒ»ç–—', 
      time: '2024', 
      tag: 'åŒ»ç–—', 
      summary: 'AIè¾…åŠ©è¯Šæ–­ã€å½±åƒè¯†åˆ«ã€è¯ç‰©ç ”å‘ç­‰é¢†åŸŸçš„çªç ´ä¸æŒ‘æˆ˜',
      images: [
        $r('app.media.content_17'),
        $r('app.media.content_18')
      ],
      authorAvatar: $r('app.media.avatar_109')
    },
    { 
      title: 'åŒºå—é“¾æŠ€æœ¯åœ¨é‡‘èé¢†åŸŸçš„å®é™…åº”ç”¨æ¡ˆä¾‹', 
      author: 'ç­”ä¸» Â· å‘¨å¼º', 
      topic: 'ä¸“é¢˜ Â· åŒºå—é“¾', 
      time: '2024', 
      tag: 'åŒºå—é“¾', 
      summary: 'æ•°å­—è´§å¸ã€æ™ºèƒ½åˆçº¦ã€ä¾›åº”é“¾é‡‘èç­‰åœºæ™¯çš„è½åœ°å®è·µ',
      images: [
        $r('app.media.content_19'),
        $r('app.media.content_20'),
        $r('app.media.content_21')
      ],
      authorAvatar: $r('app.media.avatar_110')
    },
    { 
      title: '5Gç½‘ç»œå¯¹ç‰©è”ç½‘å‘å±•çš„æ¨åŠ¨ä½œç”¨', 
      author: 'ç­”ä¸» Â· å´ç£Š', 
      topic: 'çƒ­æ¦œ Â· é€šä¿¡', 
      time: '2024', 
      tag: '5G', 
      summary: 'ä½å»¶è¿Ÿã€é«˜å¸¦å®½ç‰¹æ€§å¦‚ä½•èµ‹èƒ½æ™ºèƒ½å®¶å±…ã€å·¥ä¸šäº’è”ç½‘ç­‰åœºæ™¯',
      images: [
        $r('app.media.content_22')
      ],
      authorAvatar: $r('app.media.avatar_111')
    },
    { 
      title: 'é‡å­è®¡ç®—è·ç¦»å•†ä¸šåŒ–è¿˜æœ‰å¤šè¿œï¼Ÿ', 
      author: 'ç­”ä¸» Â· éƒ‘å', 
      topic: 'çƒ­æ¦œ Â· é‡å­', 
      time: '2024', 
      tag: 'é‡å­', 
      summary: 'æŠ€æœ¯çªç ´ã€åº”ç”¨åœºæ™¯ã€æŠ•èµ„å‰æ™¯çš„å…¨é¢åˆ†æ',
      images: [
        $r('app.media.content_23'),
        $r('app.media.content_24')
      ],
      authorAvatar: $r('app.media.avatar_112')
    },
    { 
      title: 'å…ƒå®‡å®™æ¦‚å¿µä¸‹çš„è™šæ‹Ÿç°å®æŠ€æœ¯å‘å±•', 
      author: 'ç­”ä¸» Â· å­™ä¸½', 
      topic: 'ä¸“é¢˜ Â· VR', 
      time: '2024', 
      tag: 'VR', 
      summary: 'VR/ARè®¾å¤‡ã€å†…å®¹ç”Ÿæ€ã€ç”¨æˆ·ä½“éªŒçš„ç°çŠ¶ä¸æœªæ¥',
      images: [
        $r('app.media.content_25'),
        $r('app.media.content_26'),
        $r('app.media.content_27')
      ],
      authorAvatar: $r('app.media.avatar_113')
    },
    { 
      title: 'è‡ªåŠ¨é©¾é©¶æŠ€æœ¯çš„å®‰å…¨æ€§ä¸å¯é æ€§æ¢è®¨', 
      author: 'ç­”ä¸» Â· é©¬è¶…', 
      topic: 'çƒ­æ¦œ Â· æ±½è½¦', 
      time: '2024', 
      tag: 'è‡ªåŠ¨é©¾é©¶', 
      summary: 'ä¼ æ„Ÿå™¨èåˆã€å†³ç­–ç®—æ³•ã€äº‹æ•…è´£ä»»ç­‰å…³é”®é—®é¢˜çš„æ·±åº¦è§£æ',
      images: [
        $r('app.media.content_28')
      ],
      authorAvatar: $r('app.media.avatar_114')
    },
    { 
      title: 'è¾¹ç¼˜è®¡ç®—åœ¨å·¥ä¸š4.0ä¸­çš„å…³é”®ä½œç”¨', 
      author: 'ç­”ä¸» Â· èµµæ•', 
      topic: 'ä¸“é¢˜ Â· å·¥ä¸š', 
      time: '2024', 
      tag: 'å·¥ä¸š', 
      summary: 'å®æ—¶æ•°æ®å¤„ç†ã€è®¾å¤‡ååŒã€æ™ºèƒ½åˆ¶é€ çš„åº”ç”¨å®è·µ',
      images: [
        $r('app.media.content_29'),
        $r('app.media.content_30')
      ],
      authorAvatar: $r('app.media.avatar_115')
    },
    { 
      title: 'Web3.0æ—¶ä»£çš„å»ä¸­å¿ƒåŒ–åº”ç”¨ç”Ÿæ€', 
      author: 'ç­”ä¸» Â· é»„é£', 
      topic: 'çƒ­æ¦œ Â· Web3', 
      time: '2024', 
      tag: 'Web3', 
      summary: 'DeFiã€NFTã€DAOç­‰å»ä¸­å¿ƒåŒ–åº”ç”¨çš„åˆ›æ–°ä¸æŒ‘æˆ˜',
      images: [
        $r('app.media.content_31'),
        $r('app.media.content_32'),
        $r('app.media.content_33')
      ],
      authorAvatar: $r('app.media.avatar_116')
    },
    { 
      title: 'äººå·¥æ™ºèƒ½åœ¨åˆ›æ„è®¾è®¡é¢†åŸŸçš„çªç ´', 
      author: 'ç­”ä¸» Â· æ—é™', 
      topic: 'ä¸“é¢˜ Â· è®¾è®¡', 
      time: '2024', 
      tag: 'è®¾è®¡', 
      summary: 'AIç»˜ç”»ã€æ™ºèƒ½æ’ç‰ˆã€åˆ›æ„ç”Ÿæˆçš„å·¥å…·ä¸å®è·µæ¡ˆä¾‹',
      images: [
        $r('app.media.content_34')
      ],
      authorAvatar: $r('app.media.avatar_117')
    },
    { 
      title: 'äº‘è®¡ç®—æˆæœ¬ä¼˜åŒ–çš„æœ€ä½³å®è·µ', 
      author: 'ç­”ä¸» Â· é™ˆæ˜', 
      topic: 'çƒ­æ¦œ Â· äº‘æœåŠ¡', 
      time: '2024', 
      tag: 'äº‘è®¡ç®—', 
      summary: 'èµ„æºè°ƒåº¦ã€å¼¹æ€§ä¼¸ç¼©ã€æˆæœ¬ç›‘æ§çš„ç­–ç•¥ä¸æ–¹æ³•',
      images: [
        $r('app.media.content_35'),
        $r('app.media.content_36')
      ],
      authorAvatar: $r('app.media.avatar_118')
    },
    { 
      title: 'æ•°æ®éšç§ä¿æŠ¤çš„æŠ€æœ¯æ–¹æ¡ˆä¸æ³•å¾‹æ¡†æ¶', 
      author: 'ç­”ä¸» Â· ç‹èŠ³', 
      topic: 'ä¸“é¢˜ Â· éšç§', 
      time: '2024', 
      tag: 'éšç§', 
      summary: 'å·®åˆ†éšç§ã€åŒæ€åŠ å¯†ã€GDPRåˆè§„çš„æŠ€æœ¯ä¸æ³•å¾‹è§†è§’',
      images: [
        $r('app.media.content_37'),
        $r('app.media.content_38'),
        $r('app.media.content_39')
      ],
      authorAvatar: $r('app.media.avatar_119')
    },
    { 
      title: 'ä½ä»£ç å¹³å°å¦‚ä½•æ”¹å˜è½¯ä»¶å¼€å‘æ¨¡å¼ï¼Ÿ', 
      author: 'ç­”ä¸» Â· æå†›', 
      topic: 'çƒ­æ¦œ Â· å¼€å‘', 
      time: '2024', 
      tag: 'ä½ä»£ç ', 
      summary: 'å¿«é€Ÿå¼€å‘ã€é™ä½é—¨æ§›ã€æå‡æ•ˆç‡çš„æ–°å¼€å‘èŒƒå¼',
      images: [
        $r('app.media.content_40')
      ],
      authorAvatar: $r('app.media.avatar_120')
    }
  ];
  private readonly hotTags: string[] = ['AI', 'å®‰å…¨', 'èƒ½æº', 'æ¨è', 'NLP', 'ç¼–ç¨‹', 'åŒ»ç–—', 'åŒºå—é“¾', '5G', 'é‡å­'];

  // æ¨èçŸ¥è¯†åº“æ•°æ®
  private knowledgeBases: KnowledgeBase[] = [
    {
      id: '1',
      name: 'äº‘å·¥å¼€ç‰©',
      logo: $r('app.media.kb_401'),
      description: 'é¡¹ç›®:äº‘å·¥å¼€ç‰©â€”â€”é˜¿é‡Œäº‘é«˜æ ¡æ”¯æŒè®¡åˆ’ï¼Œæä¾›ä¸°å¯Œçš„æŠ€æœ¯èµ„æºå’Œå­¦ä¹ å†…å®¹',
      subscribers: 182,
      contents: 13,
      project: 'äº‘å·¥å¼€ç‰©â€”â€”é˜¿é‡Œäº‘é«˜æ ¡æ”¯...'
    },
    {
      id: '2',
      name: 'AIæŠ€æœ¯å‰æ²¿',
      logo: $r('app.media.kb_402'),
      description: 'èšç„¦äººå·¥æ™ºèƒ½æœ€æ–°æŠ€æœ¯åŠ¨æ€ï¼Œåˆ†äº«æ·±åº¦å­¦ä¹ ã€å¤§æ¨¡å‹ç­‰å‰æ²¿çŸ¥è¯†',
      subscribers: 256,
      contents: 28,
      project: 'AIæŠ€æœ¯å‰æ²¿ç ”ç©¶'
    },
    {
      id: '3',
      name: 'å¼€å‘è€…ç¤¾åŒº',
      logo: $r('app.media.kb_403'),
      description: 'æ±‡èšå¼€å‘è€…ç»éªŒåˆ†äº«ï¼Œæ¶µç›–å‰ç«¯ã€åç«¯ã€ç§»åŠ¨å¼€å‘ç­‰å¤šä¸ªé¢†åŸŸ',
      subscribers: 189,
      contents: 35,
      project: 'å¼€å‘è€…æŠ€æœ¯äº¤æµ'
    }
  ];

  // æ¨¡æ‹Ÿç§ä¿¡æ•°æ®
  private messageList: MessageItem[] = [
    { 
      from: 'ç³»ç»Ÿé€šçŸ¥', 
      title: 'æ¬¢è¿åŠ å…¥çŸ¥ä¹ä¹ç¤¾åŒºï¼Œä¸€èµ·å‘ç°ä¼˜è´¨é—®ç­”ï½', 
      time: 'ä»Šå¤©', 
      unread: true,
      avatar: $r('app.media.avatar_201')
    },
    { 
      from: 'çŸ¥ä¹ä¹å°åŠ©æ‰‹', 
      title: 'ä½ å¯ä»¥åœ¨è¿™é‡Œæ”¶è—é—®é¢˜ã€å…³æ³¨è¯é¢˜', 
      time: 'æ˜¨å¤©', 
      unread: false,
      avatar: $r('app.media.avatar_202')
    },
    { 
      from: 'äº§å“æ›´æ–°', 
      title: 'æ–°ç‰ˆæœ¬æ”¯æŒç§ä¿¡æé†’ä¸æ¶ˆæ¯è®¢é˜…', 
      time: '3 å¤©å‰', 
      unread: false,
      avatar: $r('app.media.avatar_203')
    }
  ];

  aboutToAppear() {
    this.filtered = this.feedList;
    if (!this.currentUser) {
      this.currentUser = AppStorage.Get<string>('currentUser') ?? '';
    }
    // åˆå§‹åŒ–çŸ¥è¯†åº“ç¿»è½¬çŠ¶æ€
    this.knowledgeBases.forEach((kb: KnowledgeBase) => {
      this.knowledgeBaseFlipStates.set(kb.id, false);
    });
  }

  // åˆ‡æ¢çŸ¥è¯†åº“å¡ç‰‡ç¿»è½¬çŠ¶æ€
  private toggleKnowledgeBaseFlip(id: string) {
    const currentState = this.knowledgeBaseFlipStates.get(id) ?? false;
    this.knowledgeBaseFlipStates.set(id, !currentState);
  }

  private search() {
    const keyword = this.query.trim().toLowerCase();
    if (!keyword) {
      this.filtered = this.feedList;
      return;
    }
    this.filtered = this.feedList.filter((item: FeedItem) => {
      const content = `${item.title} ${item.author} ${item.topic} ${item.time} ${item.tag ?? ''} ${item.summary ?? ''}`.toLowerCase();
      return content.includes(keyword);
    });
  }

  private quickTag(tag: string) {
    this.query = tag;
    this.search();
  }

  private enterMine() {
      router.replaceUrl({ url: 'pages/MainPages/MinePage' });
  }

  private ensureLogin() {
    if (!this.currentUser) {
      prompt.showToast({ message: 'è¯·å…ˆç™»å½•' });
      router.replaceUrl({ url: 'pages/MainPages/ZhiHuHuLoginPage' });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ¬¢è¿+æœç´¢
      Column({ space: 8 }) {
        Row() {
          Row({ space: 8 }) {
            Image($r('app.media.logo_999'))
              .width(32)
              .height(32)
              .borderRadius(16)
              .border({ width: 2, color: '#ffffff' });
            Text('çŸ¥ä¹ä¹')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff');
          }
          .alignItems(VerticalAlign.Center)
          .padding({ left: 12, top: 10, bottom: 10 });
          
          Row({ space: 8 }) {
            if (this.currentUser) {
              Image($r('app.media.avatar_998'))
                .width(32)
                .height(32)
                .borderRadius(16)
                .border({ width: 2, color: '#ffffff' });
            }
            Text(this.currentUser ? `Hiï¼Œ${this.currentUser}` : 'æœªç™»å½•')
              .fontSize(14)
              .fontColor('#e9f3ff')
              .padding({ right: 12 })
              .onClick(() => {
                // æ— è®ºå½“å‰æ˜¯å¦ç™»å½•ï¼Œç‚¹å‡»å³ä¸Šè§’éƒ½è¿›å…¥ç»Ÿä¸€çš„ç™»å½•é¡µé¢
                router.replaceUrl({ url: 'pages/MainPages/ZhiHuHuLoginPage' });
              });
          }
          .alignItems(VerticalAlign.Center);
        }
        .backgroundColor('#0f88eb')
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        .width('100%');

        Row({ space: 10 }) {
          TextInput({ placeholder: 'æœç´¢çŸ¥ä¹ä¹å†…å®¹/é—®é¢˜', text: this.query })
            .width('70%')
            .height(42)
            .border({ width: 1, color: '#eeeeee' })
            .borderRadius(6)
            .padding({ left: 10 })
            .onChange((value: string) => {
              this.query = value;
            });

          Button('æœç´¢')
            .width('25%')
            .height(42)
            .backgroundColor('#0f88eb')
            .fontColor('#ffffff')
            .borderRadius(6)
            .onClick(() => {
              this.search();
            });
        }
        .alignItems(VerticalAlign.Center)
        .padding({ top: 12, left: 12, right: 12 });

        Row({ space: 8 }) {
          ForEach(this.hotTags, (tag: string) => {
            Button(tag)
              .type(ButtonType.Normal)
              .backgroundColor('#f0f7ff')
              .fontColor('#2b6fe8')
              .onClick(() => this.quickTag(tag));
          });
        }
        .padding({ left: 12, right: 12, bottom: 6 });
      }

      // å†…å®¹åŒº
      if (this.currentTab === 0) {
        // é¦–é¡µï¼šæœç´¢ç»“æœ/æ¨èåˆ—è¡¨
        List({ space: 10 }) {
          ForEach(this.filtered, (item: FeedItem) => {
            ListItem() {
              Column({ space: 8 }) {
                // ä½œè€…ä¿¡æ¯è¡Œï¼ˆå¸¦å¤´åƒï¼‰
                Row({ space: 8 }) {
                  if (item.authorAvatar) {
                    Image(item.authorAvatar)
                      .width(36)
                      .height(36)
                      .borderRadius(18)
                      .objectFit(ImageFit.Cover);
                  }
                  Column({ space: 2 }) {
                    Text(item.title)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#333333');
                    Text(`${item.author} | ${item.topic} | ${item.time}`)
                      .fontSize(12)
                      .fontColor('#999999');
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start);
                }
                .width('100%');

                if (item.summary) {
                  Text(item.summary)
                    .fontSize(13)
                    .fontColor('#777777')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%');
                }

                // å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
                if (item.images && item.images.length > 0) {
                  if (item.images.length === 1) {
                    // å•å¼ å›¾ç‰‡ï¼šå¤§å›¾
                    Image(item.images[0])
                      .width('100%')
                      .height(200)
                      .objectFit(ImageFit.Cover)
                      .borderRadius(8)
                      .margin({ top: 4, bottom: 4 });
                  } else if (item.images.length === 2) {
                    // ä¸¤å¼ å›¾ç‰‡ï¼šå¹¶æ’æ˜¾ç¤º
                    Row({ space: 8 }) {
                      ForEach(item.images, (img: ResourceStr) => {
                        Image(img)
                          .width('48%')
                          .aspectRatio(1)
                          .objectFit(ImageFit.Cover)
                          .borderRadius(8);
                      });
                    }
                    .width('100%')
                    .margin({ top: 4, bottom: 4 });
                  } else {
                    // ä¸‰å¼ æˆ–æ›´å¤šå›¾ç‰‡ï¼šæ¨ªå‘æ’åˆ—
                    Row({ space: 6 }) {
                      ForEach(item.images.slice(0, 3), (img: ResourceStr) => {
                        Image(img)
                          .width('31%')
                          .height(100)
                          .objectFit(ImageFit.Cover)
                          .borderRadius(6);
                      });
                    }
                    .width('100%')
                    .margin({ top: 4, bottom: 4 });
                  }
                }

                Row({ space: 8 }) {
                  if (item.tag) {
                    Text(item.tag)
                      .fontSize(12)
                      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                      .backgroundColor('#eef5ff')
                      .fontColor('#2b6fe8')
                      .borderRadius(12);
                  }
                  Blank();
                  Button('æŸ¥çœ‹è¯¦æƒ…')
                    .height(32)
                    .backgroundColor('#eeeeee')
                    .fontColor('#333333')
                    .borderRadius(6)
                    .onClick(() => {
                      router.pushUrl({
                        url: 'pages/MainPages/DetailPage',
                        params: {
                          title: item.title,
                          author: item.author,
                          topic: item.topic,
                          time: item.time,
                          summary: item.summary ?? '',
                          images: item.images ?? [],
                          authorAvatar: item.authorAvatar ?? ''
                        }
                      });
                    });
                }
                .width('100%');
              }
              .padding(12)
              .backgroundColor('#ffffff')
              .border({ width: 0.5, color: '#eeeeee' })
              .borderRadius(8)
              .margin({ bottom: 8 });
            };
          });
        }
        .padding({ left: 12, right: 12, top: 10 })
        .layoutWeight(1);
      } else if (this.currentTab === 1) {
        // å‘ç°ï¼šé‡æ–°è®¾è®¡çš„å‘ç°é¡µé¢
        Scroll() {
          Column({ space: 20 }) {
            // é¡¶éƒ¨å¤§æ ‡é¢˜
            Column({ space: 16 }) {
              Text('ç”¨æé—®å‘ç°ä¸–ç•Œ')
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .textAlign(TextAlign.Center)
                .width('100%')
                .padding({ top: 20, bottom: 8 });

              // æ¨èé—®é¢˜åŒºåŸŸ
              Column({ space: 10 }) {
                Button('æˆ¿ä»·ä¸‹è·Œå¯¹æ™®é€šäººæ„å‘³ç€ä»€ä¹ˆ?')
                  .type(ButtonType.Normal)
                  .width('90%')
                  .height(44)
                  .backgroundColor('#f5f5f5')
                  .fontColor('#666666')
                  .fontSize(14)
                  .borderRadius(22)
                  .onClick(() => {
                    this.currentTab = 0;
                    this.query = 'æˆ¿ä»·';
                    this.search();
                    prompt.showToast({ message: 'å·²ä¸ºä½ ç­›é€‰ï¼šæˆ¿ä»· ä¸‹è·Œ æ™®é€šäºº' });
                  });

                Button('å¦‚ä½•éƒ¨ç½²DeepSeekè”ç½‘?')
                  .type(ButtonType.Normal)
                  .width('90%')
                  .height(44)
                  .backgroundColor('#f5f5f5')
                  .fontColor('#666666')
                  .fontSize(14)
                  .borderRadius(22)
                  .onClick(() => {
                    this.currentTab = 0;
                    this.query = 'DeepSeek';
                    this.search();
                    prompt.showToast({ message: 'å·²ä¸ºä½ ç­›é€‰ï¼šDeepSeek è”ç½‘ éƒ¨ç½²' });
                  });

                Button('ç´¢å°¼åœ¨å†å²ä¸Šæœ‰å“ªäº›ç»å…¸äº§å“?')
                  .type(ButtonType.Normal)
                  .width('90%')
                  .height(44)
                  .backgroundColor('#f5f5f5')
                  .fontColor('#666666')
                  .fontSize(14)
                  .borderRadius(22)
                  .onClick(() => {
                    this.currentTab = 0;
                    this.query = 'ç´¢å°¼';
                    this.search();
                    prompt.showToast({ message: 'å·²ä¸ºä½ ç­›é€‰ï¼šç´¢å°¼ ç»å…¸ äº§å“' });
                  });
              }
              .width('100%')
              .alignItems(HorizontalAlign.Center)
              .padding({ top: 8, bottom: 16 });
            }
            .width('100%')
            .padding({ bottom: 8 });

            // æ¨èçŸ¥è¯†åº“æ¨¡å—
            Column({ space: 12 }) {
              // æ ‡é¢˜æ 
              Row() {
                Text('æ¨èçŸ¥è¯†åº“')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333');
                Blank();
                Row({ space: 4 }) {
                  Text('çŸ¥è¯†å¹¿åœº')
                    .fontSize(14)
                    .fontColor('#0f88eb');
                  Text('>')
                    .fontSize(16)
                    .fontColor('#0f88eb');
                }
                .onClick(() => {
                  prompt.showToast({ message: 'è¿›å…¥çŸ¥è¯†å¹¿åœº' });
                });
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 8 });

              // çŸ¥è¯†åº“å¡ç‰‡åˆ—è¡¨ï¼ˆå¯æ¨ªå‘æ»šåŠ¨ï¼‰
              Scroll() {
                Row({ space: 12 }) {
                  ForEach(this.knowledgeBases, (kb: KnowledgeBase) => {
                    // å¯ç¿»è½¬çš„çŸ¥è¯†åº“å¡ç‰‡
                    Stack({ alignContent: Alignment.Center }) {
                      // æ­£é¢
                      Column({ space: 8 }) {
                        Row({ space: 10 }) {
                          Image(kb.logo)
                            .width(60)
                            .height(60)
                            .borderRadius(8)
                            .objectFit(ImageFit.Cover);
                          Column({ space: 4 }) {
                            Text(kb.name)
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)
                              .fontColor('#333333');
                            if (kb.project) {
                              Text(kb.project)
                                .fontSize(12)
                                .fontColor('#666666')
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis });
                            }
                          }
                          .layoutWeight(1)
                          .alignItems(HorizontalAlign.Start);
                        }
                        .width('100%');

                        Text(`${kb.name}Â·${kb.subscribers}äººè®¢é˜…Â·${kb.contents}ä¸ªå†…å®¹`)
                          .fontSize(12)
                          .fontColor('#999999')
                          .width('100%');
                      }
                      .width(280)
                      .height(120)
                      .padding(12)
                      .backgroundColor('#ffffff')
                      .borderRadius(12)
                      .shadow({ radius: 8, color: '#e5ebf5', offsetX: 0, offsetY: 2 })
                      .rotate({ x: 0, y: 1, z: 0, angle: this.knowledgeBaseFlipStates.get(kb.id) ? 180 : 0 })
                      .opacity(this.knowledgeBaseFlipStates.get(kb.id) ? 0 : 1)
                      .animation({ duration: 400, curve: Curve.EaseInOut });

                      // èƒŒé¢ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
                      Column({ space: 8 }) {
                        Text(kb.name)
                          .fontSize(18)
                          .fontWeight(FontWeight.Bold)
                          .fontColor('#333333')
                          .margin({ bottom: 4 });
                        Text(kb.description)
                          .fontSize(13)
                          .fontColor('#666666')
                          .maxLines(4)
                          .textOverflow({ overflow: TextOverflow.Ellipsis });
                        Row({ space: 12 }) {
                          Column() {
                            Text(`${kb.subscribers}`)
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)
                              .fontColor('#0f88eb');
                            Text('è®¢é˜…')
                              .fontSize(11)
                              .fontColor('#999999');
                          }
                          .alignItems(HorizontalAlign.Center);
                          Column() {
                            Text(`${kb.contents}`)
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)
                              .fontColor('#0f88eb');
                            Text('å†…å®¹')
                              .fontSize(11)
                              .fontColor('#999999');
                          }
                          .alignItems(HorizontalAlign.Center);
                        }
                        .margin({ top: 8 })
                        .width('100%')
                        .justifyContent(FlexAlign.SpaceAround);
                      }
                      .width(280)
                      .height(120)
                      .padding(12)
                      .backgroundColor('#f0f7ff')
                      .borderRadius(12)
                      .shadow({ radius: 8, color: '#e5ebf5', offsetX: 0, offsetY: 2 })
                      .rotate({ x: 0, y: 1, z: 0, angle: this.knowledgeBaseFlipStates.get(kb.id) ? 0 : -180 })
                      .opacity(this.knowledgeBaseFlipStates.get(kb.id) ? 1 : 0)
                      .animation({ duration: 400, curve: Curve.EaseInOut });
                    }
                    .width(280)
                    .height(120)
                    .onClick(() => {
                      this.toggleKnowledgeBaseFlip(kb.id);
                    });
                  });
                }
                .padding({ left: 16, right: 16 });
              }
              .scrollable(ScrollDirection.Horizontal)
              .scrollBar(BarState.Auto)
              .width('100%')
              .height(140);
            }
            .width('100%')
            .padding({ bottom: 8 })
            .backgroundColor('#f9f9f9');

            // åº•éƒ¨è¾“å…¥æ 
            // åº•éƒ¨è¾“å…¥æ 
            Row({ space: 10 }) {
              // æ™ºèƒ½æ€è€ƒæŒ‰é’®
              Button('æ™ºèƒ½æ€è€ƒ')
                .type(ButtonType.Normal)
                .height(44)
                .backgroundColor('#f0f7ff')
                .fontColor('#0f88eb')
                .fontSize(14)
                .borderRadius(22)
                .padding({ left: 16, right: 16 })
                .onClick(() => {
                  prompt.showToast({ message: 'æ™ºèƒ½æ€è€ƒåŠŸèƒ½' });
                });

              // çŸ¥æŒ‰é’®
              Button('çŸ¥')
                .type(ButtonType.Normal)
                .width(44)
                .height(44)
                .backgroundColor('#f0f7ff')
                .fontColor('#0f88eb')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .borderRadius(22)
                .onClick(() => {
                  prompt.showToast({ message: 'çŸ¥è¯†åŠŸèƒ½' });
                });

              // è¾“å…¥æ¡†
              Row({ space: 8 }) {
                Text('ğŸ¤')
                  .fontSize(20)
                  .margin({ left: 14 });
                Text('è¾“å…¥ä½ çš„é—®é¢˜,ä½¿ç”¨@æé—®ç­”ä¸»/çŸ¥è¯†')
                  .fontSize(14)
                  .fontColor('#999999')
                  .layoutWeight(1)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis });
                Text('ğŸ“')
                  .fontSize(20)
                  .margin({ right: 14 });
              }
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#ffffff')
              .border({ width: 1, color: '#e0e0e0', radius: 22 })
              .borderRadius(22)
              .alignItems(VerticalAlign.Center)
              .onClick(() => {
                prompt.showToast({ message: 'ç‚¹å‡»è¾“å…¥é—®é¢˜' });
              });
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 20, bottom: 20 })
            .backgroundColor('#ffffff');
          }
          .width('100%');
        }
        .layoutWeight(1);
      } else if (this.currentTab === 2) {
        // ç§ä¿¡ï¼šç™»å½•åæŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯ / ç§ä¿¡åˆ—è¡¨
        if (!this.currentUser) {
          Column({ space: 16 }) {
            Text('ç§ä¿¡')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#0f88eb');
            Text('è¯·å…ˆç™»å½•åæŸ¥çœ‹ç§ä¿¡ä¸é€šçŸ¥')
              .fontSize(14)
              .fontColor('#666666');

            Button('è¿”å›é¦–é¡µ')
              .width(160)
              .height(40)
              .backgroundColor('#0f88eb')
              .fontColor('#ffffff')
              .borderRadius(8)
              .onClick(() => {
                this.currentTab = 0;
              });
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center);
        } else {
          Column({ space: 10 }) {
            Text('ç§ä¿¡ä¸é€šçŸ¥')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#0f88eb');

            List({ space: 8 }) {
              ForEach(this.messageList, (msg: MessageItem, index: number) => {
                ListItem() {
                  Row({ space: 12 }) {
                    // ç”¨æˆ·å¤´åƒ
                    if (msg.avatar) {
                      Image(msg.avatar)
                        .width(50)
                        .height(50)
                        .borderRadius(25)
                        .objectFit(ImageFit.Cover)
                        .border({ width: 2, color: '#f0f0f0' });
                    } else {
                      // é»˜è®¤å¤´åƒå ä½
                      Column()
                        .width(50)
                        .height(50)
                        .borderRadius(25)
                        .backgroundColor('#e0e0e0')
                        .justifyContent(FlexAlign.Center)
                        .alignItems(HorizontalAlign.Center);
                    }
                    
                    Column({ space: 4 }) {
                      Row({ space: 8 }) {
                        Text(msg.from)
                          .fontSize(15)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#333333');
                        if (msg.unread) {
                          Text('æœªè¯»')
                            .fontSize(10)
                            .fontColor('#ffffff')
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .backgroundColor('#ff4d4f')
                            .borderRadius(10);
                        }
                      }
                      .width('100%');
                      Text(msg.title)
                        .fontSize(14)
                        .fontWeight(msg.unread ? FontWeight.Bold : FontWeight.Normal)
                        .fontColor('#333333')
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis });
                      Text(msg.time)
                        .fontSize(12)
                        .fontColor('#999999');
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Start);
                  }
                  .padding(12)
                  .backgroundColor('#ffffff')
                  .borderRadius(10)
                  .onClick(() => {
                    // æ‰“å¼€å¯¹è¯è¯¦æƒ…é¡µï¼Œå¹¶æ ‡è®°ä¸ºå·²è¯»
                    this.messageList[index].unread = false;
                    router.pushUrl({
                      url: 'pages/MainPages/MessageDetailPage',
                      params: {
                        from: msg.from,
                        title: msg.title,
                        time: msg.time
                      }
                    });
                  });
                };
              });
            }
          }
          .padding({ left: 16, right: 16, top: 16, bottom: 12 })
          .layoutWeight(1);
        }
      } else {
        // â€œæˆ‘çš„â€å ä½é¡µï¼šå¸¦è¿”å›æŒ‰é’®ï¼Œåº•éƒ¨ä»æœ‰ç»Ÿä¸€å¯¼èˆªæ 
        Column({ space: 16 }) {
          Text('æ­£åœ¨è·³è½¬åˆ°â€œæˆ‘çš„â€')
            .fontSize(16)
            .fontColor('#666666');

          Button('è¿”å›é¦–é¡µ')
            .width(160)
            .height(40)
            .backgroundColor('#0f88eb')
            .fontColor('#ffffff')
            .borderRadius(8)
            .onClick(() => {
              // ä»…åˆ‡å›é¦–é¡µ tabï¼Œä¸åšè·¯ç”±è·³è½¬
              this.currentTab = 0;
            });
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center);
      }

      // åº•éƒ¨å¯¼èˆªæ ï¼ˆå«ä¸­é—´å‘å¸ƒæŒ‰é’®ï¼‰
      Row() {
        Column() {
          Text('é¦–é¡µ')
            .fontSize(14)
            .fontColor(this.currentTab === 0 ? '#0f88eb' : '#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 0;
        });

        Column() {
          Text('å‘ç°')
            .fontSize(14)
            .fontColor(this.currentTab === 1 ? '#0f88eb' : '#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 1;
        });

        // ä¸­é—´å‘å¸ƒæŒ‰é’®
        Column() {
          Text('+')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff');
        }
        .width(50)
        .height(50)
        .borderRadius(25)
        .backgroundColor('#0f88eb')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.ensureLogin();
          if (this.currentUser) {
            router.pushUrl({ url: 'pages/MainPages/PublishPage' });
          }
        });

        Column() {
          Text('ç§ä¿¡')
            .fontSize(14)
            .fontColor(this.currentTab === 2 ? '#0f88eb' : '#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 2;
          if (!this.currentUser) {
            this.ensureLogin();
          }
        });

        Column() {
          Text('æˆ‘çš„')
            .fontSize(14)
            .fontColor('#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.ensureLogin();
          this.enterMine();
        });
      }
      .height(60)
      .backgroundColor('#ffffff')
      .border({ width: 0.5, color: '#eeeeee', radius: 0 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f9f9f9');
  }
}


