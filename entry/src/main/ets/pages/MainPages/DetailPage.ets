import router from '@ohos.router';
import prompt from '@ohos.promptAction';

interface DetailParams {
  title?: string;
  author?: string;
  topic?: string;
  time?: string;
  summary?: string;
  images?: ResourceStr[];
  authorAvatar?: ResourceStr;
}

interface CommentItem {
  id: string;
  user: string;
  avatar: ResourceStr;
  content: string;
  time: string;
  likes: number;
  isLiked: boolean;
}

@Entry
@Component
struct DetailPage {
  private params: DetailParams = {};
  @State isLiked: boolean = false;
  @State likeCount: number = 128;
  @State isCollected: boolean = false;
  @State collectCount: number = 56;
  @State commentCount: number = 32;
  @State showCommentInput: boolean = false;
  @State commentText: string = '';
  @State comments: CommentItem[] = [
    {
      id: '1',
      user: 'çƒ­å¿ƒç½‘å‹',
      avatar: $r('app.media.avatar_301'),
      content: 'è¿™ä¸ªå›žç­”å¤ªæ£’äº†ï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼',
      time: '2å°æ—¶å‰',
      likes: 42,
      isLiked: false
    },
    {
      id: '2',
      user: 'çŸ¥ä¹Žä¹Žç”¨æˆ·',
      avatar: $r('app.media.avatar_302'),
      content: 'è¯´å¾—éžå¸¸æœ‰é“ç†ï¼ŒèµžåŒï¼',
      time: '5å°æ—¶å‰',
      likes: 18,
      isLiked: false
    },
    {
      id: '3',
      user: 'åŒ¿åç”¨æˆ·',
      avatar: $r('app.media.avatar_303'),
      content: 'è¯·é—®è¿˜æœ‰æ›´å¤šç›¸å…³å†…å®¹æŽ¨èå—ï¼Ÿ',
      time: '1å¤©å‰',
      likes: 7,
      isLiked: false
    }
  ];

  aboutToAppear() {
    const p = router.getParams() as DetailParams;
    if (p) {
      this.params = p;
    }
  }

  private toggleLike() {
    this.isLiked = !this.isLiked;
    this.likeCount += this.isLiked ? 1 : -1;
    prompt.showToast({ message: this.isLiked ? 'å·²ç‚¹èµž' : 'å–æ¶ˆç‚¹èµž' });
  }

  private toggleCollect() {
    this.isCollected = !this.isCollected;
    this.collectCount += this.isCollected ? 1 : -1;
    prompt.showToast({ message: this.isCollected ? 'å·²æ”¶è—' : 'å–æ¶ˆæ”¶è—' });
  }

  private shareContent() {
    prompt.showToast({ message: 'åˆ†äº«åŠŸèƒ½ï¼šå¤åˆ¶é“¾æŽ¥æˆåŠŸ' });
  }

  private submitComment() {
    if (this.commentText.trim().length === 0) {
      prompt.showToast({ message: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º' });
      return;
    }
    const newComment: CommentItem = {
      id: `${Date.now()}`,
      user: 'æˆ‘',
      avatar: $r('app.media.avatar_999'),
      content: this.commentText,
      time: 'åˆšåˆš',
      likes: 0,
      isLiked: false
    };
    this.comments = [newComment, ...this.comments];
    this.commentCount += 1;
    this.commentText = '';
    this.showCommentInput = false;
    prompt.showToast({ message: 'è¯„è®ºæˆåŠŸ' });
  }

  private toggleCommentLike(index: number) {
    const comment = this.comments[index];
    comment.isLiked = !comment.isLiked;
    comment.likes += comment.isLiked ? 1 : -1;
    this.comments[index] = comment;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#333333')
          .padding({ left: 16, right: 16 })
          .onClick(() => router.back());

        Text('è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1);

        Text('â‹®')
          .fontSize(24)
          .fontColor('#333333')
          .padding({ left: 16, right: 16 })
          .onClick(() => prompt.showToast({ message: 'æ›´å¤šé€‰é¡¹' }));
      }
      .width('100%')
      .height(56)
      .backgroundColor('#ffffff')
      .alignItems(VerticalAlign.Center);

      // å†…å®¹åŒºå¯æ»šåŠ¨
      Scroll() {
        Column({ space: 16 }) {
          // æ ‡é¢˜
          Text(this.params.title ?? 'è¯¦æƒ…')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .width('100%')
            .textAlign(TextAlign.Start);

          // ä½œè€…ä¿¡æ¯è¡Œ
          Row({ space: 10 }) {
            if (this.params.authorAvatar) {
              Image(this.params.authorAvatar)
                .width(44)
                .height(44)
                .borderRadius(22)
                .objectFit(ImageFit.Cover);
            }
            Column({ space: 4 }) {
              Text(this.params.author ?? '')
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333');
              Text(`${this.params.topic ?? ''} Â· ${this.params.time ?? ''}`)
                .fontSize(12)
                .fontColor('#999999');
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start);

            Button('+ å…³æ³¨')
              .height(32)
              .backgroundColor('#0f88eb')
              .fontColor('#ffffff')
              .fontSize(13)
              .borderRadius(16)
              .padding({ left: 12, right: 12 })
              .onClick(() => prompt.showToast({ message: 'å·²å…³æ³¨' }));
          }
          .width('100%');

          Divider().color('#e8e8e8').strokeWidth(1);

          // æ­£æ–‡æ‘˜è¦
          if (this.params.summary) {
            Text(this.params.summary as string)
              .fontSize(16)
              .fontColor('#555555')
              .lineHeight(26)
              .width('100%')
              .textAlign(TextAlign.Start);
          }

          // è¯¦ç»†å†…å®¹
          Column({ space: 12 }) {
            Text('è¯¦ç»†å›žç­”ï¼š')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .width('100%');

            Text('è¿™æ˜¯ä¸€ä¸ªéžå¸¸æœ‰è¶£çš„é—®é¢˜ã€‚è®©æˆ‘æ¥è¯¦ç»†è§£ç­”ä¸€ä¸‹ã€‚åœ¨å½“ä»Šç¤¾ä¼šï¼Œè¿™ä¸ªè¯é¢˜è¶Šæ¥è¶Šå—åˆ°å¤§å®¶çš„å…³æ³¨ã€‚')
              .fontSize(15)
              .fontColor('#666666')
              .lineHeight(26)
              .width('100%');

            Text('é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç†è§£è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨ã€‚ä»ŽåŽ†å²å‘å±•çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªçŽ°è±¡å¹¶ä¸æ˜¯è¿‘å¹´æ‰å‡ºçŽ°çš„ï¼Œè€Œæ˜¯æœ‰ç€æ·±åŽšçš„ç¤¾ä¼šèƒŒæ™¯å’Œæ–‡åŒ–æ ¹æºã€‚')
              .fontSize(15)
              .fontColor('#666666')
              .lineHeight(26)
              .width('100%');

            Text('ä»Žå¤šä¸ªè§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°å¿ƒç†å­¦ã€ç¤¾ä¼šå­¦ç­‰å¤šä¸ªé¢†åŸŸã€‚æ¯ä¸ªäººçš„ç†è§£å’Œæ„Ÿå—éƒ½å¯èƒ½ä¸åŒï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸ªè¯é¢˜èƒ½å¤Ÿå¼•èµ·å¹¿æ³›è®¨è®ºçš„åŽŸå› ä¹‹ä¸€ã€‚')
              .fontSize(15)
              .fontColor('#666666')
              .lineHeight(26)
              .width('100%');

            Text('æœ€åŽï¼Œæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¯¹äºŽè¿™ç±»é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥ä¿æŒå¼€æ”¾çš„å¿ƒæ€ï¼Œå°Šé‡ä¸åŒçš„è§‚ç‚¹ï¼Œç†æ€§åœ°è¿›è¡Œè®¨è®ºå’Œäº¤æµã€‚')
              .fontSize(15)
              .fontColor('#666666')
              .lineHeight(26)
              .width('100%');
          }
          .width('100%');

          // å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
          if (this.params.images && this.params.images.length > 0) {
            Column({ space: 12 }) {
              Text('ç›¸å…³å›¾ç‰‡ï¼š')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .width('100%');

              if (this.params.images.length === 1) {
                Image(this.params.images[0])
                  .width('100%')
                  .height(280)
                  .objectFit(ImageFit.Cover)
                  .borderRadius(12);
              } else if (this.params.images.length === 2) {
                Row({ space: 10 }) {
                        ForEach(this.params.images, (img: ResourceStr) => {
                    Image(img)
                      .width('48%')
                      .aspectRatio(1)
                      .objectFit(ImageFit.Cover)
                      .borderRadius(12);
                  });
                }
                .width('100%');
              } else {
                if (this.params.images) {
                  Column({ space: 10 }) {
                    Row({ space: 10 }) {
                      ForEach(this.params.images.slice(0, 2), (img: ResourceStr) => {
                        Image(img)
                          .width('48%')
                          .aspectRatio(1)
                          .objectFit(ImageFit.Cover)
                          .borderRadius(12);
                      });
                    }
                    .width('100%');
                    if (this.params.images && this.params.images.length >= 3) {
                      Row({ space: 10 }) {
                        ForEach(this.params.images.slice(2, Math.min(5, this.params.images.length)), (img: ResourceStr) => {
                          Image(img)
                            .width(this.params.images!.length === 3 ? '100%' : '31%')
                            .height(this.params.images!.length === 3 ? 180 : 120)
                            .objectFit(ImageFit.Cover)
                            .borderRadius(12);
                        });
                      }
                      .width('100%');
                    }
                  }
                  .width('100%');
                }
              }
            }
            .width('100%');
          }

          // äº’åŠ¨åŒºåŸŸï¼ˆç‚¹èµžã€æ”¶è—ã€åˆ†äº«ç»Ÿè®¡ï¼‰
          Row() {
            Row({ space: 6 }) {
              Text(this.isLiked ? 'â¤ï¸' : 'ðŸ¤')
                .fontSize(18);
              Text(`${this.likeCount}`)
                .fontSize(14)
                .fontColor('#666666');
            }
            .padding({ left: 16, right: 16 })
            .onClick(() => this.toggleLike());

            Row({ space: 6 }) {
              Text(this.isCollected ? 'â­' : 'â˜†')
                .fontSize(18);
              Text(`${this.collectCount}`)
                .fontSize(14)
                .fontColor('#666666');
            }
            .padding({ left: 16, right: 16 })
            .onClick(() => this.toggleCollect());

            Row({ space: 6 }) {
              Text('ðŸ’¬')
                .fontSize(18);
              Text(`${this.commentCount}`)
                .fontSize(14)
                .fontColor('#666666');
            }
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              this.showCommentInput = !this.showCommentInput;
            });

            Blank();

            Row({ space: 6 }) {
              Text('â†—')
                .fontSize(18);
              Text('åˆ†äº«')
                .fontSize(14)
                .fontColor('#666666');
            }
            .padding({ left: 16, right: 16 })
            .onClick(() => this.shareContent());
          }
          .width('100%')
          .height(48)
          .backgroundColor('#f9f9f9')
          .borderRadius(12);

          // è¯„è®ºè¾“å…¥åŒºï¼ˆå¯æ”¶èµ·ï¼‰
          if (this.showCommentInput) {
            Column({ space: 10 }) {
              TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: this.commentText })
                .width('100%')
                .height(80)
                .backgroundColor('#ffffff')
                .border({ width: 1, color: '#e0e0e0' })
                .borderRadius(8)
                .padding(10)
                .onChange((value: string) => {
                  this.commentText = value;
                });

              Row({ space: 12 }) {
                Blank();
                Button('å–æ¶ˆ')
                  .height(36)
                  .backgroundColor('#f5f5f5')
                  .fontColor('#666666')
                  .borderRadius(18)
                  .onClick(() => {
                    this.showCommentInput = false;
                    this.commentText = '';
                  });
                Button('å‘å¸ƒ')
                  .height(36)
                  .backgroundColor('#0f88eb')
                  .fontColor('#ffffff')
                  .borderRadius(18)
                  .onClick(() => this.submitComment());
              }
              .width('100%');
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#f5f5f5')
            .borderRadius(12);
          }

          // è¯„è®ºåˆ—è¡¨
          Column({ space: 12 }) {
            Row() {
              Text('å…¨éƒ¨è¯„è®º')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333');
              Blank();
              Text(`${this.commentCount}æ¡`)
                .fontSize(14)
                .fontColor('#999999');
            }
            .width('100%');

            ForEach(this.comments, (comment: CommentItem, index: number) => {
              Row({ space: 10 }) {
                Image(comment.avatar)
                  .width(36)
                  .height(36)
                  .borderRadius(18)
                  .objectFit(ImageFit.Cover);

                Column({ space: 4 }) {
                  Row() {
                    Text(comment.user)
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#333333');
                    Blank();
                    Text(comment.time)
                      .fontSize(12)
                      .fontColor('#999999');
                  }
                  .width('100%');

                  Text(comment.content)
                    .fontSize(14)
                    .fontColor('#555555')
                    .lineHeight(22)
                    .width('100%');

                  Row({ space: 4 }) {
                    Text(comment.isLiked ? 'â¤ï¸' : 'ðŸ¤')
                      .fontSize(14);
                    Text(`${comment.likes}`)
                      .fontSize(12)
                      .fontColor('#999999');
                  }
                  .onClick(() => this.toggleCommentLike(index));
                }
                .layoutWeight(1);
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#ffffff')
              .borderRadius(10);
            });
          }
          .width('100%');

          // å»¶ä¼¸é˜…è¯»
          Column({ space: 12 }) {
            Text('å»¶ä¼¸é˜…è¯»ï¼š')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .width('100%');

            Text('1. ç›¸å…³è¯é¢˜è®¨è®º')
              .fontSize(15)
              .fontColor('#0f88eb')
              .width('100%')
              .onClick(() => prompt.showToast({ message: 'è·³è½¬åˆ°ç›¸å…³è¯é¢˜' }));

            Text('2. ç±»ä¼¼é—®é¢˜æŽ¨è')
              .fontSize(15)
              .fontColor('#0f88eb')
              .width('100%')
              .onClick(() => prompt.showToast({ message: 'è·³è½¬åˆ°ç±»ä¼¼é—®é¢˜' }));

            Text('3. ç­”ä¸»å…¶ä»–å›žç­”')
              .fontSize(15)
              .fontColor('#0f88eb')
              .width('100%')
              .onClick(() => prompt.showToast({ message: 'æŸ¥çœ‹ç­”ä¸»å…¶ä»–å›žç­”' }));
          }
          .width('100%')
          .padding({ top: 8 });
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 100 });
      }
      .layoutWeight(1);

      // åº•éƒ¨æ“ä½œæ 
      Row({ space: 12 }) {
        Row({ space: 8 }) {
          Text('ðŸ’¬')
            .fontSize(20);
          Text('å†™è¯„è®º...')
            .fontSize(14)
            .fontColor('#999999');
        }
        .layoutWeight(1)
        .height(40)
        .backgroundColor('#f5f5f5')
        .borderRadius(20)
        .padding({ left: 16 })
        .alignItems(VerticalAlign.Center)
        .onClick(() => {
          this.showCommentInput = true;
        });

        Column() {
          Text(this.isLiked ? 'â¤ï¸' : 'ðŸ¤')
            .fontSize(22);
          Text(`${this.likeCount}`)
            .fontSize(10)
            .fontColor('#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .onClick(() => this.toggleLike());

        Column() {
          Text(this.isCollected ? 'â­' : 'â˜†')
            .fontSize(22);
          Text(`${this.collectCount}`)
            .fontSize(10)
            .fontColor('#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .onClick(() => this.toggleCollect());

        Column() {
          Text('â†—')
            .fontSize(22);
          Text('åˆ†äº«')
            .fontSize(10)
            .fontColor('#666666');
        }
        .alignItems(HorizontalAlign.Center)
        .onClick(() => this.shareContent());
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { top: 0.5 }, color: '#e8e8e8' });
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f7f8fa');
  }
}
